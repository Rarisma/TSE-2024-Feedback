@page "/"
@rendermode InteractiveServer
@inject JAuth JAuth
@using Application.API
@using FeedbackTrackerCommon.Definitions
@inject FeedbackAPI FeedbackClientAccess



<PageTitle>Feedback Tracking Tool</PageTitle>

<div>
    <center><h1>Feedback Tracking Tool</h1></center>
    <br><br />
    <center><h2>Dashboard</h2></center>

    <div>
        <h3>Recent Feedback</h3>
        
            <div>
            @foreach (var feedback in allFeedback)
                {
                    <div style="border: 1px solid black; margin: 5px; padding: 10px;">
                        <h4>@feedback.Title</h4>
                        <p><strong>@feedback.FeedbackText</strong></p>
                        <p><strong>Completed:</strong> @feedback.Closed</p>
                    </div>
                }
            </div>
        
    </div>
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        JAuth.EnforceAuth();
        if(JAuth.IsAuthorised()){
            await LoadFeedback();
        }

    }

    private List<FeedbackTrackerCommon.Definitions.Feedback> allFeedback = new();

    // loads feedback from api
    private async Task LoadFeedback()
    {
        try
        {

            List<FeedbackTrackerCommon.Definitions.Feedback> feedbackList = await FeedbackClientAccess.GetAssignedFeedbacks(6);

            if (feedbackList != null && feedbackList.Any())
            {
                allFeedback = feedbackList.Select(fb => new FeedbackTrackerCommon.Definitions.Feedback()
                    {
                        Title = fb.Title,
                        FeedbackText = fb.FeedbackText,
                        Closed = fb.Closed
                    }).ToList();
            }
            else
            {
                Console.WriteLine("No feedback found. Using test data.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading feedback: {ex.Message}");
        }
    }
}
